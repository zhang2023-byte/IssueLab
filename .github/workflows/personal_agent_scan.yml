name: Personal Agent Scan

# ç”¨æˆ·forkåçš„ä¸ªäººåŒ–æ‰«ææœºåˆ¶
# å®šæœŸåˆ†æä¸»ä»“åº“çš„issuesï¼Œé€‰æ‹©æ„Ÿå…´è¶£çš„è¯é¢˜å‚ä¸è®¨è®º
on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆé¿å…è¿‡äºé¢‘ç¹ï¼‰
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      max_issues:
        description: 'æœ€å¤šå›å¤çš„issueæ•°é‡'
        required: false
        default: '3'
        type: number

# å¹¶å‘æ§åˆ¶
concurrency:
  group: personal-agent-scan
  cancel-in-progress: true

permissions:
  contents: read
  issues: write  # éœ€è¦åœ¨ä¸»ä»“åº“å‘å¸ƒè¯„è®º

env:
  # ä¸»ä»“åº“é…ç½®ï¼ˆå¯ä»¥è¢«forkç”¨æˆ·è¦†ç›–ï¼‰
  MAIN_REPO: 'gqy20/IssueLab'
  MAX_ISSUES_TO_REPLY: ${{ github.event.inputs.max_issues || '3' }}

jobs:
  personal-scan:
    # ğŸ”’ ä»…åœ¨forkä»“åº“è¿è¡Œï¼Œä¸åœ¨ä¸»ä»“åº“è¿è¡Œ
    if: github.repository != 'gqy20/IssueLab'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Detect personal agent
        id: detect_agent
        run: |
          # å°è¯•ä»agents/ç›®å½•ä¸­æ£€æµ‹ç”¨æˆ·çš„agent
          AGENT_DIR="agents"
          
          # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç”¨æˆ·agenté…ç½®æ–‡ä»¶ï¼ˆæ’é™¤_registry, _templateï¼‰
          AGENT_FILE=$(find "$AGENT_DIR" -maxdepth 2 -name "agent.yml" \
            -not -path "$AGENT_DIR/_registry/*" \
            -not -path "$AGENT_DIR/_template/*" \
            | head -n 1)
          
          if [ -z "$AGENT_FILE" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·agenté…ç½®ï¼Œè·³è¿‡æ‰«æ"
            echo "has_agent=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå–agentåç§°ï¼ˆä»ç›®å½•åï¼‰
          AGENT_NAME=$(dirname "$AGENT_FILE" | xargs basename)
          echo "âœ… æ£€æµ‹åˆ°ç”¨æˆ·agent: $AGENT_NAME"
          echo "has_agent=true" >> $GITHUB_OUTPUT
          echo "agent_name=$AGENT_NAME" >> $GITHUB_OUTPUT

      - name: Get open issues from main repo
        if: steps.detect_agent.outputs.has_agent == 'true'
        id: get_issues
        run: |
          # è·å–ä¸»ä»“åº“çš„å¼€æ”¾issuesï¼ˆæ’é™¤å·²å‚ä¸çš„ï¼‰
          gh issue list \
            --repo "${{ env.MAIN_REPO }}" \
            --state open \
            --json number,title,labels,author \
            --limit 20 \
            > /tmp/issues.json
          
          # è¿‡æ»¤å‡ºæœªå‚ä¸è¿‡çš„issues
          python - <<EOF
          import json
          import subprocess
          
          with open('/tmp/issues.json') as f:
              issues = json.load(f)
          
          # è·å–å½“å‰ä»“åº“æ‰€æœ‰è€…ï¼ˆforkç”¨æˆ·ï¼‰
          repo_owner = "${{ github.repository_owner }}"
          
          # è¿‡æ»¤æ¡ä»¶ï¼š
          # 1. ä¸æ˜¯è‡ªå·±åˆ›å»ºçš„issue
          # 2. æ²¡æœ‰bot:quietæ ‡ç­¾
          # 3. æ²¡æœ‰è‡ªå·±å‚ä¸è¿‡çš„è¯„è®º
          filtered = []
          for issue in issues:
              # æ£€æŸ¥ä½œè€…
              if issue.get('author', {}).get('login', '') == repo_owner:
                  continue
              
              # æ£€æŸ¥æ ‡ç­¾
              labels = [l['name'] for l in issue.get('labels', [])]
              if 'bot:quiet' in labels or 'bot:processing' in labels:
                  continue
              
              # TODO: æ£€æŸ¥æ˜¯å¦å·²ç»è¯„è®ºè¿‡ï¼ˆéœ€è¦APIè°ƒç”¨ï¼‰
              filtered.append(issue['number'])
          
          # é™åˆ¶æ•°é‡
          filtered = filtered[:20]
          issue_numbers = ','.join(map(str, filtered))
          
          print(f"æ‰¾åˆ° {len(filtered)} ä¸ªå¯èƒ½æ„Ÿå…´è¶£çš„issues")
          
          with open('/tmp/issue_numbers.txt', 'w') as f:
              f.write(issue_numbers)
          EOF
          
          ISSUE_NUMBERS=$(cat /tmp/issue_numbers.txt)
          ISSUE_COUNT=$(echo "$ISSUE_NUMBERS" | tr ',' '\n' | grep -c '^[0-9]' || echo 0)
          
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          echo "issue_numbers=$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ° $ISSUE_COUNT ä¸ªå€™é€‰issues: $ISSUE_NUMBERS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze issues with personal agent
        if: steps.detect_agent.outputs.has_agent == 'true' && steps.get_issues.outputs.issue_count > 0
        id: analyze
        run: |
          # ä½¿ç”¨ä¸ªäººagentåˆ†æå“ªäº›issuesæ„Ÿå…´è¶£
          echo "=== ä½¿ç”¨ ${{ steps.detect_agent.outputs.agent_name }} åˆ†æissues ==="
          
          # åˆ›å»ºpersonal-scanå‘½ä»¤æ¥åˆ†æissues
          # TODO: éœ€è¦å®ç°personal-scanå‘½ä»¤
          uv run python -m issuelab personal-scan \
            --agent "${{ steps.detect_agent.outputs.agent_name }}" \
            --issues "${{ steps.get_issues.outputs.issue_numbers }}" \
            --max-replies "${{ env.MAX_ISSUES_TO_REPLY }}" \
            --repo "${{ env.MAIN_REPO }}" \
            > /tmp/scan_results.json || true
          
          # è§£æç»“æœ
          if [ -f /tmp/scan_results.json ]; then
            SELECTED_ISSUES=$(cat /tmp/scan_results.json | jq -r '.selected_issues | join(",")')
            SELECTED_COUNT=$(echo "$SELECTED_ISSUES" | tr ',' '\n' | grep -c '^[0-9]' || echo 0)
            
            echo "selected_issues=$SELECTED_ISSUES" >> $GITHUB_OUTPUT
            echo "selected_count=$SELECTED_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… é€‰æ‹©äº† $SELECTED_COUNT ä¸ªissuesè¿›è¡Œå›å¤: $SELECTED_ISSUES"
          else
            echo "âš ï¸ åˆ†æå¤±è´¥ï¼Œè·³è¿‡"
            echo "selected_count=0" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}

      - name: Reply to selected issues
        if: steps.analyze.outputs.selected_count > 0
        run: |
          # å¯¹é€‰ä¸­çš„issuesè¿›è¡Œå›å¤
          SELECTED_ISSUES="${{ steps.analyze.outputs.selected_issues }}"
          
          echo "=== å¼€å§‹å›å¤ ${{ steps.analyze.outputs.selected_count }} ä¸ªissues ==="
          
          for issue_num in $(echo "$SELECTED_ISSUES" | tr ',' '\n'); do
            echo "ğŸ“ å›å¤ Issue #$issue_num..."
            
            # ä½¿ç”¨ä¸ªäººagentå›å¤issue
            uv run python -m issuelab personal-reply \
              --agent "${{ steps.detect_agent.outputs.agent_name }}" \
              --issue "$issue_num" \
              --repo "${{ env.MAIN_REPO }}" \
              --post || echo "âš ï¸ å›å¤å¤±è´¥"
            
            # é¿å…è§¦å‘rate limit
            sleep 5
          done
          
          echo "âœ… å®Œæˆæ‰€æœ‰å›å¤"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: personal-scan-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

  # æç¤ºjobï¼šå¦‚æœåœ¨ä¸»ä»“åº“è¿è¡Œï¼Œç»™å‡ºæç¤º
  main-repo-notice:
    if: github.repository == 'gqy20/IssueLab'
    runs-on: ubuntu-latest
    steps:
      - name: Show notice
        run: |
          echo "â„¹ï¸ Personal Agent Scan è®¾è®¡ç”¨äºforkä»“åº“"
          echo "â„¹ï¸ ä¸»ä»“åº“è¯·ä½¿ç”¨ Observer Auto-Trigger workflow"
          echo "â„¹ï¸ å¦‚éœ€æµ‹è¯•ï¼Œè¯·åœ¨forkä»“åº“ä¸­è¿è¡Œ"
