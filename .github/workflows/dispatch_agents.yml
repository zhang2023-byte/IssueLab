name: Dispatch to User Agents

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  issues: write
  actions: write  # 需要触发其他仓库的 workflows

jobs:
  dispatch:
    runs-on: ubuntu-latest
    # 允许 Agent 回复中的 @mention 触发分发

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Parse mentions from Issue
        if: github.event_name == 'issues'
        id: parse_issue
        run: |
          # 使用临时文件避免多行内容的 shell 解析问题
          ISSUE_BODY_FILE=$(mktemp)
          echo -n "${{ github.event.issue.body }}" > "$ISSUE_BODY_FILE"

          uv run python scripts/parse_mentions.py \
            --issue-body-file "$ISSUE_BODY_FILE" \
            --output json

          rm -f "$ISSUE_BODY_FILE"

      - name: Parse mentions from Comment
        if: github.event_name == 'issue_comment'
        id: parse_comment
        run: |
          # 使用临时文件避免多行内容的 shell 解析问题
          COMMENT_BODY_FILE=$(mktemp)
          echo -n "${{ github.event.comment.body }}" > "$COMMENT_BODY_FILE"

          uv run python scripts/parse_mentions.py \
            --comment-body-file "$COMMENT_BODY_FILE" \
            --output json

          rm -f "$COMMENT_BODY_FILE"

      - name: Get labels
        id: labels
        run: |
          # 将 JSON 转换为单行格式
          labels=$(echo '${{ toJson(github.event.issue.labels.*.name) }}' | tr -d '\n' | tr -d ' ')
          echo "labels=$labels" >> $GITHUB_OUTPUT

      - name: Collect available agents
        id: collect_agents
        run: |
          # 收集所有启用的agents信息
          python << 'EOF'
          import json
          import yaml
          from pathlib import Path

          agents_dir = Path("agents")
          agents_list = []

          if agents_dir.exists():
              for user_dir in agents_dir.iterdir():
                  if not user_dir.is_dir():
                      continue
                  # 跳过模板目录
                  if user_dir.name.startswith("_"):
                      continue
                  agent_yml = user_dir / "agent.yml"
                  if not agent_yml.exists():
                      continue
                  try:
                      with open(agent_yml) as f:
                          config = yaml.safe_load(f)

                      if config and config.get("enabled", True):
                          username = config.get("owner") or config.get("username")
                          triggers = config.get("triggers", [])
                          description = config.get("description", "")

                          if username and triggers:
                              agents_list.append({
                                  "name": triggers[0] if triggers else f"@{username}",
                                  "description": description or f"{username} agent"
                              })
                  except Exception as e:
                      print(f"Warning: Failed to load {agent_yml}: {e}")

          # 输出为JSON（单行，供workflow使用）
          with open("/tmp/agents.json", "w") as f:
              json.dump(agents_list, f, ensure_ascii=False, separators=(",", ":"))
          print(json.dumps(agents_list, ensure_ascii=False, separators=(",", ":")))
          EOF

          agents_json=$(cat /tmp/agents.json)
          echo "agents=$agents_json" >> $GITHUB_OUTPUT
          agent_count=$(echo "$agents_json" | python -c 'import sys, json; print(len(json.load(sys.stdin)))')
          echo "收集到 $agent_count 个可用智能体"

      - name: Dispatch to user repositories
        id: dispatch
        continue-on-error: true  # 允许部分失败
        run: |
          # 使用单引号包裹 JSON 以避免 bash 解析问题
          mentions='${{ steps.parse_issue.outputs.mentions || steps.parse_comment.outputs.mentions }}'

          if [ -z "$mentions" ] || [ "$mentions" = "[]" ]; then
            echo "No mentions found, skipping dispatch"
            exit 0
          fi

          # 将多行内容写入临时文件，避免命令行参数解析问题
          ISSUE_BODY_FILE=$(mktemp)
          COMMENT_BODY_FILE=$(mktemp)
          echo -n "${{ github.event.issue.body }}" > "$ISSUE_BODY_FILE"
          echo -n "${{ github.event.comment.body }}" > "$COMMENT_BODY_FILE"

          python -m issuelab.cli.dispatch \
            --mentions "$mentions" \
            --agents-dir agents \
            --source-repo "${{ github.repository }}" \
            --issue-number ${{ github.event.issue.number }} \
            --issue-title "${{ github.event.issue.title }}" \
            --issue-body-file "$ISSUE_BODY_FILE" \
            ${{ github.event_name == 'issue_comment' && format('--comment-id {0}', github.event.comment.id) || '' }} \
            --comment-body-file "$COMMENT_BODY_FILE" \
            --labels '${{ steps.labels.outputs.labels }}' \
            --available-agents '${{ steps.collect_agents.outputs.agents }}' \
            --use-github-app

          # 清理临时文件
          rm -f "$ISSUE_BODY_FILE" "$COMMENT_BODY_FILE"
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          GITHUB_APP_ID: ${{ secrets.ISSUELAB_APP_ID }}
          GITHUB_APP_PRIVATE_KEY: ${{ secrets.ISSUELAB_APP_PRIVATE_KEY }}
          LOG_FILE: ${{ github.workspace }}/logs/dispatch_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG

      - uses: actions/upload-artifact@v4
        with:
          name: dispatch-logs-${{ github.event.issue.number }}-${{ github.run_id }}
          path: logs/
          retention-days: 7

      - name: Report dispatch results
        if: always() && steps.dispatch.outcome != 'skipped'
        run: |
          echo "Dispatch completed with status: ${{ steps.dispatch.outcome }}"
          if [ -n "${{ steps.dispatch.outputs.dispatched_count }}" ]; then
            echo "Successfully dispatched to ${{ steps.dispatch.outputs.dispatched_count }}/${{ steps.dispatch.outputs.total_count }} agents"
          fi

      # 本地执行主仓库 Agents
      - name: Run local agents
        if: steps.dispatch.outputs.local_agents != '[]' && steps.dispatch.outputs.local_agents != ''
        run: |
          LOCAL_AGENTS='${{ steps.dispatch.outputs.local_agents }}'
          echo "Running local agents: $LOCAL_AGENTS"

          # 解析 JSON 数组并逐个执行
          echo "$LOCAL_AGENTS" | jq -r '.[]' | while read -r agent; do
            echo "[LOCAL] Executing agent: $agent"
            uv run python -m issuelab execute \
              --issue ${{ github.event.issue.number }} \
              --agents "$agent" \
              --post || echo "[WARNING] Failed to run $agent locally"
          done
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/local_agents_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"

      - name: Comment on dispatch failure
        if: steps.dispatch.outcome == 'failure' && steps.dispatch.outputs.dispatched_count == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const totalCount = parseInt('${{ steps.dispatch.outputs.total_count }}') || 0;
            const dispatchedCount = parseInt('${{ steps.dispatch.outputs.dispatched_count }}') || 0;

            let message = '⚠️ **Agent Dispatch Report**\n\n';

            if (dispatchedCount === 0 && totalCount > 0) {
              message += `❌ Failed to dispatch to all ${totalCount} matched agents.\n\n`;
              message += '**Possible reasons:**\n';
              message += '- Fork repositories require `workflow_dispatch` mode\n';
              message += '- Target workflows may not be enabled\n';
              message += '- PAT_TOKEN may lack required permissions (`repo` + `workflow`)\n\n';
              message += '**For fork repository owners:**\n';
              message += '1. Update your workflow to use `workflow_dispatch` trigger\n';
              message += '2. Update your registry file to set `dispatch_mode: workflow_dispatch`\n\n';
            } else if (dispatchedCount < totalCount) {
              message += `⚠️ Partially successful: ${dispatchedCount}/${totalCount} agents.\n\n`;
            }

            message += `[View detailed logs](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
