name: Dispatch to User Agents

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  issues: write
  actions: write  # 需要触发其他仓库的 workflows

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install PyYAML requests PyJWT cryptography

      - name: Parse mentions from Issue
        if: github.event_name == 'issues'
        id: parse_issue
        run: |
          python scripts/parse_mentions.py \
            --issue-body "${{ github.event.issue.body }}" \
            --output json

      - name: Parse mentions from Comment
        if: github.event_name == 'issue_comment'
        id: parse_comment
        run: |
          python scripts/parse_mentions.py \
            --comment-body "${{ github.event.comment.body }}" \
            --output json

      - name: Get labels
        id: labels
        run: |
          # 将 JSON 转换为单行格式
          labels=$(echo '${{ toJson(github.event.issue.labels.*.name) }}' | tr -d '\n' | tr -d ' ')
          echo "labels=$labels" >> $GITHUB_OUTPUT

      - name: Collect available agents
        id: collect_agents
        run: |
          # 收集所有启用的agents信息
          python << 'EOF'
          import json
          import yaml
          from pathlib import Path

          registry_dir = Path("agents/_registry")
          agents_list = []

          if registry_dir.exists():
              for yml_file in registry_dir.glob("*.yml"):
                  try:
                      with open(yml_file) as f:
                          config = yaml.safe_load(f)
                      
                      if config and config.get("enabled", True):
                          username = config.get("username")
                          triggers = config.get("triggers", [])
                          description = config.get("description", "")
                          
                          if username and triggers:
                              agents_list.append({
                                  "name": triggers[0] if triggers else f"@{username}",
                                  "description": description or f"{username} 智能体"
                              })
                  except Exception as e:
                      print(f"Warning: Failed to load {yml_file.name}: {e}")

          # 输出为JSON（单行，供workflow使用）
          with open("/tmp/agents.json", "w") as f:
              json.dump(agents_list, f, ensure_ascii=False, separators=(",", ":"))
          print(json.dumps(agents_list, ensure_ascii=False, separators=(",", ":")))
          EOF
          
          agents_json=$(cat /tmp/agents.json)
          echo "agents=$agents_json" >> $GITHUB_OUTPUT
          agent_count=$(echo "$agents_json" | python -c 'import sys, json; print(len(json.load(sys.stdin)))')
          echo "收集到 $agent_count 个可用智能体"

      - name: Dispatch to user repositories
        id: dispatch
        continue-on-error: true  # 允许部分失败
        run: |
          # 使用单引号包裹 JSON 以避免 bash 解析问题
          mentions='${{ steps.parse_issue.outputs.mentions || steps.parse_comment.outputs.mentions }}'

          if [ -z "$mentions" ] || [ "$mentions" = "[]" ]; then
            echo "No mentions found, skipping dispatch"
            exit 0
          fi

          python -m issuelab.cli.dispatch \
            --mentions "$mentions" \
            --registry-dir agents/_registry \
            --source-repo "${{ github.repository }}" \
            --issue-number ${{ github.event.issue.number }} \
            --issue-title "${{ github.event.issue.title }}" \
            --issue-body "${{ github.event.issue.body }}" \
            ${{ github.event_name == 'issue_comment' && format('--comment-id {0}', github.event.comment.id) || '' }} \
            ${{ github.event_name == 'issue_comment' && format('--comment-body "{0}"', github.event.comment.body) || '' }} \
            --labels '${{ steps.labels.outputs.labels }}' \
            --available-agents '${{ steps.collect_agents.outputs.agents }}' \
            --use-github-app
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          GITHUB_APP_ID: ${{ secrets.ISSUELAB_APP_ID }}
          GITHUB_APP_PRIVATE_KEY: ${{ secrets.ISSUELAB_APP_PRIVATE_KEY }}
          LOG_FILE: ${{ github.workspace }}/logs/dispatch_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG

      # 上传日志文件
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dispatch-logs-${{ github.event.issue.number }}-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Report dispatch results
        if: always() && steps.dispatch.outcome != 'skipped'
        run: |
          echo "Dispatch completed with status: ${{ steps.dispatch.outcome }}"
          if [ -n "${{ steps.dispatch.outputs.dispatched_count }}" ]; then
            echo "Successfully dispatched to ${{ steps.dispatch.outputs.dispatched_count }}/${{ steps.dispatch.outputs.total_count }} agents"
          fi

      - name: Comment on dispatch failure
        if: steps.dispatch.outcome == 'failure' && steps.dispatch.outputs.dispatched_count == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const totalCount = parseInt('${{ steps.dispatch.outputs.total_count }}') || 0;
            const dispatchedCount = parseInt('${{ steps.dispatch.outputs.dispatched_count }}') || 0;

            let message = '⚠️ **Agent Dispatch Report**\n\n';

            if (dispatchedCount === 0 && totalCount > 0) {
              message += `❌ Failed to dispatch to all ${totalCount} matched agents.\n\n`;
              message += '**Possible reasons:**\n';
              message += '- Fork repositories require `workflow_dispatch` mode\n';
              message += '- Target workflows may not be enabled\n';
              message += '- PAT_TOKEN may lack required permissions (`repo` + `workflow`)\n\n';
              message += '**For fork repository owners:**\n';
              message += '1. Update your workflow to use `workflow_dispatch` trigger\n';
              message += '2. Update your registry file to set `dispatch_mode: workflow_dispatch`\n\n';
            } else if (dispatchedCount < totalCount) {
              message += `⚠️ Partially successful: ${dispatchedCount}/${totalCount} agents.\n\n`;
            }

            message += `[View detailed logs](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
