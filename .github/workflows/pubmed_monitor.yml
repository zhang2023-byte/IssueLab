name: PubMed Monitor

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹è¿è¡Œä¸€æ¬¡
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      query:
        description: 'PubMed æ£€ç´¢è¯'
        required: false
        default: '"Speciation"[Mesh] OR "Hybridization, Genetic"[Mesh] OR "Genetic Introgression"[Mesh]'
        type: string
      days:
        description: 'è¿½æº¯å¤©æ•°'
        required: false
        default: '1'
        type: string
      max_papers:
        description: 'æœ€å¤§æ–‡çŒ®æ•°ï¼ˆåˆ†æå‰ï¼‰'
        required: false
        default: '20'
        type: string

concurrency:
  group: pubmed-monitor
  cancel-in-progress: true

permissions:
  issues: write
  contents: read

env:
  QUERY: ${{ github.event.inputs.query || '"Speciation"[Mesh] OR "Hybridization, Genetic"[Mesh] OR "Genetic Introgression"[Mesh]' }}
  DAYS: ${{ github.event.inputs.days || '1' }}
  MAX_PAPERS: ${{ github.event.inputs.max_papers || '20' }}
  GH_TOKEN: ${{ secrets.PAT_TOKEN }}
  LOG_LEVEL: DEBUG
  PUBMED_EMAIL: ${{ secrets.PUBMED_EMAIL }}
  # Anthropic API é…ç½®
  ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
  ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
  ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
  CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"

jobs:
  monitor:
    if: github.repository == 'gqy20/IssueLab'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Run PubMed Monitor
        run: |
          echo "ğŸ” æ‰«æ PubMed æ–°æ–‡çŒ®..."
          echo "ğŸ“Š æ£€ç´¢è¯: ${{ env.QUERY }}"
          echo "ğŸ“… è¿½æº¯å¤©æ•°: ${{ env.DAYS }}"
          echo ""

          uv run python scripts/monitor_pubmed.py \
            --token "${{ env.GH_TOKEN }}" \
            --repo "${{ github.repository }}" \
            --query '${{ env.QUERY }}' \
            --days ${{ env.DAYS }} \
            --max-papers ${{ env.MAX_PAPERS }} \
            --email "${{ env.PUBMED_EMAIL }}"
