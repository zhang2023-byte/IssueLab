name: arXiv Monitor

# æ¯6å°æ—¶æ‰«æ arXiv æ–°è®ºæ–‡ï¼Œè‡ªåŠ¨åˆ›å»º Issue è®¨è®º
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      categories:
        description: 'arXiv categories (comma-separated)'
        required: false
        default: 'cs.AI,cs.LG,cs.CL'
        type: string
      max_papers:
        description: 'Max papers per run'
        required: false
        default: '5'
        type: string

# å¹¶å‘æ§åˆ¶ï¼šé¿å…å¤šæ¬¡æ‰«æå †ç§¯
concurrency:
  group: arxiv-monitor
  cancel-in-progress: true

permissions:
  issues: write
  contents: read

env:
  # é»˜è®¤ç›‘æ§çš„ arXiv åˆ†ç±»
  CATEGORIES: ${{ github.event.inputs.categories || 'cs.AI,cs.LG,cs.CL' }}
  MAX_PAPERS: ${{ github.event.inputs.max_papers || '5' }}

jobs:
  monitor:
    # ğŸ”’ ä»…åœ¨ä¸»ä»“åº“è¿è¡Œï¼Œé¿å…åœ¨forkä»“åº“ä¸­æ‰§è¡Œ
    if: github.repository == 'gqy20/IssueLab'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install feedparser requests

      - name: Get last scan time
        id: last_scan
        run: |
          # å°è¯•è¯»å–ä¸Šæ¬¡æ‰«ææ—¶é—´
          if [ -f .arxiv_last_scan ]; then
            LAST_SCAN=$(cat .arxiv_last_scan)
            echo "last_scan=$LAST_SCAN" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ°ä¸Šæ¬¡æ‰«æè®°å½•: $LAST_SCAN"
          else
            # é»˜è®¤ 7 å¤©å‰
            LAST_SCAN=$(date -d '7 days ago' --iso-8601=seconds)
            echo "last_scan=$LAST_SCAN" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°ä¸Šæ¬¡æ‰«æè®°å½•ï¼Œä½¿ç”¨ 7 å¤©å‰: $LAST_SCAN"
          fi

      - name: Fetch new papers from arXiv
        id: fetch
        run: |
          python scripts/monitor_arxiv.py \
            --categories "${{ env.CATEGORIES }}" \
            --last-scan "${{ steps.last_scan.outputs.last_scan }}" \
            --max-papers ${{ env.MAX_PAPERS }} \
            --output /tmp/new_papers.json

          PAPER_COUNT=$(jq length /tmp/new_papers.json || echo 0)
          echo "å‘ç° $PAPER_COUNT ç¯‡æ–°è®ºæ–‡"
          echo "paper_count=$PAPER_COUNT" >> $GITHUB_OUTPUT

      - name: Create issues for new papers
        if: steps.fetch.outputs.paper_count > 0
        id: create_issues
        run: |
          CREATED=0

          for row in $(jq -r '.[] | @base64' /tmp/new_papers.json); do
            PAPER=$(echo "$row" | base64 -d)
            TITLE=$(echo "$PAPER" | jq -r '.title')
            SUMMARY=$(echo "$PAPER" | jq -r '.summary')
            URL=$(echo "$PAPER" | jq -r '.url')
            AUTHORS=$(echo "$PAPER" | jq -r '.authors')
            PUBLISHED=$(echo "$PAPER" | jq -r '.published')
            CATEGORY=$(echo "$PAPER" | jq -r '.category')

            # åˆ›å»º Issue
            ISSUE_BODY=$(cat <<EOF
## ğŸ“„ è®ºæ–‡ä¿¡æ¯

**æ ‡é¢˜**: $TITLE
**ä½œè€…**: $AUTHORS
**å‘å¸ƒæ—¶é—´**: $PUBLISHED
**åˆ†ç±»**: $CATEGORY
**é“¾æ¥**: [arXiv]($URL)

## ğŸ“ æ‘˜è¦

$SUMMARY

## ğŸ’¬ è®¨è®º

è¯·å¯¹è¿™ç¯‡è®ºæ–‡å‘è¡¨æ‚¨çš„è§è§£ï¼š

- è®ºæ–‡çš„åˆ›æ–°ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
- æ–¹æ³•æ˜¯å¦åˆç†ï¼Ÿ
- å®éªŒç»“æœæ˜¯å¦å¯ä¿¡ï¼Ÿ
- æœ‰å“ªäº›å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Ÿ

@Moderator è¯·åˆ†è¯Š

---

_ç”± arXiv Monitor è‡ªåŠ¨åˆ›å»º_
EOF
)

            # ä½¿ç”¨ä¸­æ–‡æ ‡é¢˜å‰ç¼€
            ISSUE_TITLE="[è®ºæ–‡è®¨è®º] $TITLE"

            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„ Issue
            if gh issue list --repo ${{ github.repository }} --state all --jq "[.[] | select(.title == \"$ISSUE_TITLE\")] | length" | grep -q "0"; then
              gh issue create \
                --title "$ISSUE_TITLE" \
                --body "$ISSUE_BODY" \
                --repo ${{ github.repository }}

              CREATED=$((CREATED + 1))
              echo "âœ… åˆ›å»º Issue: ${TITLE:0:50}..."
            else
              echo "â­ï¸  å·²å­˜åœ¨ï¼Œè·³è¿‡: ${TITLE:0:50}..."
            fi

            # é¿å… rate limit
            sleep 2
          done

          echo "æˆåŠŸåˆ›å»º $CREATED ä¸ª Issue"
          echo "created_count=$CREATED" >> $GITHUB_OUTPUT

      - name: Update last scan time
        run: |
          date --iso-8601=seconds > .arxiv_last_scan
          echo "æ›´æ–°æ—¶é—´æˆ³: $(cat .arxiv_last_scan)"

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: arxiv-monitor-results-${{ github.run_id }}
          path: |
            /tmp/new_papers.json
            .arxiv_last_scan
          retention-days: 7

      - name: Summary comment
        if: always()
        run: |
          if [ "${{ steps.create_issues.outputs.created_count }}" = "0" ] && [ "${{ steps.fetch.outputs.paper_count }}" = "0" ]; then
            echo "ğŸ“­ æœ¬æ¬¡æ‰«ææœªå‘ç°æ–°è®ºæ–‡"
          elif [ "${{ steps.create_issues.outputs.created_count }}" = "0" ]; then
            echo "âš ï¸ å‘ç° ${{ steps.fetch.outputs.paper_count }} ç¯‡è®ºæ–‡ï¼Œä½†å…¨éƒ¨å·²å­˜åœ¨"
          else
            echo "âœ… æ‰«æå®Œæˆï¼šåˆ›å»º ${{ steps.create_issues.outputs.created_count }} ä¸ªæ–° Issue"
          fi
