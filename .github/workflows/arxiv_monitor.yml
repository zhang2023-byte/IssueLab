name: arXiv Monitor

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      categories:
        description: 'arXiv categories'
        required: false
        default: 'cs.AI,cs.LG,cs.CL,cs.CV,cs.RO,cs.IR,cs.NE,stat.ML'
        type: string
      max_recommended:
        description: 'Max recommended papers to create issues'
        required: false
        default: '2'
        type: string

concurrency:
  group: arxiv-monitor
  cancel-in-progress: true

permissions:
  issues: write
  contents: read
  actions: write

env:
  CATEGORIES: ${{ github.event.inputs.categories || 'cs.AI,cs.LG,cs.CL,cs.CV,cs.RO,cs.IR,cs.NE,stat.ML' }}
  MAX_RECOMMENDED: ${{ github.event.inputs.max_recommended || '2' }}
  # èŽ·å–æ›´å¤šè®ºæ–‡ä¾›æ™ºèƒ½åˆ†æžï¼Œåˆ†æžåŽç­›é€‰åˆ›å»º Issue
  FETCH_PAPERS: 20
  GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
  # å¯ç”¨ DEBUG æ—¥å¿—ä»¥æ˜¾ç¤º Agent å®Œæ•´æ‰§è¡Œè¿‡ç¨‹
  LOG_LEVEL: DEBUG
  MCP_LOG_DETAIL: "1"
  PROMPT_LOG: "1"
  # Anthropic API é…ç½®
  ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
  ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
  ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
  CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"

jobs:
  monitor:
    if: github.repository == 'gqy20/IssueLab'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Get last scan time
        id: last_scan
        run: |
          LAST_SCAN=$(gh api -X GET "repos/${{ github.repository }}/actions/variables/ARXIV_LAST_SCAN" --jq '.value' 2>/dev/null || true)

          if [ -n "$LAST_SCAN" ]; then
            echo "Using persisted ARXIV_LAST_SCAN: $LAST_SCAN"
            echo "last_scan=$LAST_SCAN" >> $GITHUB_OUTPUT
          else
            LAST_SCAN=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)
            echo "ARXIV_LAST_SCAN not found, fallback to: $LAST_SCAN"
            echo "last_scan=$LAST_SCAN" >> $GITHUB_OUTPUT
          fi

      - name: Fetch, analyze & create issues
        run: |
          echo "ðŸ” æ‰«æ arXiv æ–°è®ºæ–‡..."
          echo "ðŸ“¥ èŽ·å– ${{ env.FETCH_PAPERS }} ç¯‡å€™é€‰è®ºæ–‡ä¾›åˆ†æž"
          echo ""

          uv run python scripts/monitor_arxiv.py \
            --token "${{ env.GH_TOKEN }}" \
            --repo "${{ github.repository }}" \
            --categories "${{ env.CATEGORIES }}" \
            --max-papers ${{ env.FETCH_PAPERS }} \
            --max-recommended ${{ env.MAX_RECOMMENDED }} \
            --last-scan "${{ steps.last_scan.outputs.last_scan }}"

      - name: Update last scan time
        run: |
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "Updating ARXIV_LAST_SCAN to: $NOW"

          if gh api -X PATCH "repos/${{ github.repository }}/actions/variables/ARXIV_LAST_SCAN" \
            -f name='ARXIV_LAST_SCAN' \
            -f value="$NOW" >/dev/null 2>&1; then
            echo "Updated existing ARXIV_LAST_SCAN"
          else
            gh api -X POST "repos/${{ github.repository }}/actions/variables" \
              -f name='ARXIV_LAST_SCAN' \
              -f value="$NOW" >/dev/null
            echo "Created ARXIV_LAST_SCAN"
          fi
