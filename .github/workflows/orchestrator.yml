name: Issue Orchestrator

# 支持三种触发方式：@mention、/command、标签变更
on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [labeled]

# 并发控制：允许多个触发共存，每个触发独立运行
concurrency:
  group: ${{ github.event.issue.number }}-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read

jobs:
  # ========== 标签触发：state:ready-for-review ==========
  auto-trigger-review:
    if: github.event_name == 'issues' &&
        github.event.action == 'labeled' &&
        github.event.label.name == 'state:ready-for-review'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Update issue state
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --remove-label "state:ready-for-review" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Run full review process
        run: |
          echo "Running review flow..."
          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/auto_review_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
          ACTIONS_STEP_DEBUG: "true"
          ACTIONS_RUNNER_DEBUG: "true"

      - name: Mark needs summary
        if: always()
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: auto-review-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  # ========== @mention 触发：检测并分发 ==========
  detect-mentions:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      agents: ${{ steps.detect.outputs.agents }}
      has_builtin: ${{ steps.detect.outputs.has_builtin }}

    steps:
      - name: Detect built-in agents
        id: detect
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          COMMENT="$COMMENT_BODY"

          # 定义内置 Agent 映射（只使用真名）
          declare -A AGENT_MAP=(
            ["moderator"]="moderator"
            ["reviewer_a"]="reviewer_a"
            ["reviewer_b"]="reviewer_b"
            ["summarizer"]="summarizer"
            ["observer"]="observer"
            ["echo"]="echo"
            ["test"]="test"
          )

          # 查找匹配的内置 Agent（不区分大小写）
          FOUND_AGENTS=""
          for alias in "${!AGENT_MAP[@]}"; do
            if echo "$COMMENT" | grep -qi "@${alias}"; then
              AGENT="${AGENT_MAP[$alias]}"
              if [ -z "$FOUND_AGENTS" ]; then
                FOUND_AGENTS="$AGENT"
              elif [[ ",$FOUND_AGENTS," != *",$AGENT,"* ]]; then
                FOUND_AGENTS="$FOUND_AGENTS,$AGENT"
              fi
            fi
          done

          if [ -n "$FOUND_AGENTS" ]; then
            echo "has_builtin=true" >> $GITHUB_OUTPUT
            echo "agents=$FOUND_AGENTS" >> $GITHUB_OUTPUT
            echo "Found built-in agents: $FOUND_AGENTS"
          else
            echo "has_builtin=false" >> $GITHUB_OUTPUT
            echo "No built-in agents found"
          fi

  # ========== 运行内置 Agent（并行 Job） ==========
  run-moderator:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_builtin == 'true' && contains(needs.detect-mentions.outputs.agents, 'moderator')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: moderator
          issue-number: ${{ github.event.issue.number }}
      - uses: actions/upload-artifact@v4
        with:
          name: moderator-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-reviewer_a:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_builtin == 'true' && contains(needs.detect-mentions.outputs.agents, 'reviewer_a')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: reviewer_a
          issue-number: ${{ github.event.issue.number }}
      - uses: actions/upload-artifact@v4
        with:
          name: reviewer-a-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-reviewer_b:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_builtin == 'true' && contains(needs.detect-mentions.outputs.agents, 'reviewer_b')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: reviewer_b
          issue-number: ${{ github.event.issue.number }}
      - uses: actions/upload-artifact@v4
        with:
          name: reviewer-b-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-summarizer:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_builtin == 'true' && contains(needs.detect-mentions.outputs.agents, 'summarizer')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: summarizer
          issue-number: ${{ github.event.issue.number }}

      - name: Check for auto-close
        if: always()
        run: |
          LAST_COMMENT=$(gh issue comments ${{ github.event.issue.number }} --repo ${{ github.repository }} --limit 1 --json body -q '.[0].body' 2>/dev/null || echo "")
          if echo "$LAST_COMMENT" | grep -q '\[CLOSE\]'; then
            echo "[INFO] 检测到 [CLOSE] 标记，正在关闭 Issue..."
            gh issue close ${{ github.event.issue.number }} --repo ${{ github.repository }} --reason "completed"
            echo "[OK] Issue 已自动关闭"
          else
            echo "[INFO] 未检测到 [CLOSE] 标记，不自动关闭"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: summarizer-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-echo:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_builtin == 'true' && contains(needs.detect-mentions.outputs.agents, 'echo')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: echo
          issue-number: ${{ github.event.issue.number }}
      - uses: actions/upload-artifact@v4
        with:
          name: echo-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  # ========== /command 触发（/review, /quiet, /close, /confirm-close） ==========
  process-command:
    if: github.event_name == 'issue_comment' &&
        (contains(github.event.comment.body, '/review') ||
         contains(github.event.comment.body, '/quiet') ||
         contains(github.event.comment.body, '/close') ||
         contains(github.event.comment.body, '/confirm-close')) &&
        !contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Extract command
        id: extract
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          COMMENT="$COMMENT_BODY"
          if echo "$COMMENT" | grep -q '/confirm-close'; then
            echo "command=/confirm-close" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/review'; then
            echo "command=/review" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/quiet'; then
            echo "command=/quiet" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/close'; then
            echo "command=/close" >> $GITHUB_OUTPUT
          fi

      - name: Handle quiet command
        if: steps.extract.outputs.command == '/quiet'
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:quiet" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Request close confirmation
        if: steps.extract.outputs.command == '/close'
        run: |
          echo "[INFO] 收到关闭 Issue 请求，需要确认..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:pending-close" \
            --repo ${{ github.repository }}
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body - <<-EOF
            ## 关闭确认

            此 Issue 即将被关闭。请回复 **/confirm-close** 以确认关闭，或任意回复以取消。

            > 由 @${{ github.event.comment.user.login }} 发起关闭请求
            EOF
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Confirm and close issue
        if: steps.extract.outputs.command == '/confirm-close'
        run: |
          echo "[OK] 确认关闭 Issue..."
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "bot:pending-close" \
            --repo ${{ github.repository }}
          gh issue close ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --reason "completed"
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "[OK] Issue 已由 @${{ github.event.comment.user.login }} 手动关闭"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Run review process
        if: steps.extract.outputs.command == '/review'
        run: |
          echo "Running /review command..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --repo ${{ github.repository }}
          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/review_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
          ACTIONS_STEP_DEBUG: "true"
          ACTIONS_RUNNER_DEBUG: "true"

      - uses: actions/upload-artifact@v4
        with:
          name: command-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  # ========== Observer 触发：bot:trigger-* 标签 ==========
  observer-triggered-agent:
    if: github.event_name == 'issues' &&
        github.event.action == 'labeled' &&
        startsWith(github.event.label.name, 'bot:trigger-')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Extract agent name from label
        id: extract_agent
        run: |
          LABEL="${{ github.event.label.name }}"
          AGENT_NAME="${LABEL#bot:trigger-}"
          echo "agent_name=${AGENT_NAME}" >> $GITHUB_OUTPUT
          echo "[INFO] 将执行agent: ${AGENT_NAME}"

      - name: Execute triggered agent
        run: |
          AGENT_NAME="${{ steps.extract_agent.outputs.agent_name }}"
          echo "Running agent: ${AGENT_NAME} for Issue #${{ github.event.issue.number }}"
          uv run python -m issuelab execute \
            --issue ${{ github.event.issue.number }} \
            --agents "${AGENT_NAME}" \
            --post
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/triggered_${{ steps.extract_agent.outputs.agent_name }}_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"

      - name: Remove trigger label
        if: always()
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "${{ github.event.label.name }}" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: triggered-agent-logs-${{ steps.extract_agent.outputs.agent_name }}-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7
