name: Issue Orchestrator

# ÊîØÊåÅ‰∏âÁßçËß¶ÂèëÊñπÂºèÔºö@mention„ÄÅ/command„ÄÅÊ†áÁ≠æÂèòÊõ¥
"on":
  issue_comment:
    types: [created, edited]
  issues:
    types: [labeled]

# Âπ∂ÂèëÊéßÂà∂ÔºöÂêå‰∏Ä Issue ‰∏ç‰ºöÂπ∂ÂèëËøêË°å
concurrency:
  group: ${{ github.event.issue.number }}
  cancel-in-progress: true

# ÂÖ®Â±ÄË∂ÖÊó∂ËÆæÁΩÆÔºö10 ÂàÜÈíü
timeout-minutes: 10

permissions:
  issues: write
  contents: read

jobs:
  # ========== Ê†áÁ≠æËß¶ÂèëÔºöstate:ready-for-review ==========
  auto-trigger-review:
    if: github.event_name == 'issues' &&
        github.event.action == 'labeled' &&
        github.event.label.name == 'state:ready-for-review'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Cache arxiv-mcp-server
        uses: actions/cache@v4
        with:
          path: ~/.local/share/uv/tools/arxiv-mcp-server
          key: arxiv-mcp-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            arxiv-mcp-${{ runner.os }}-

      - name: Run full review process
        run: |
          echo "üè∑Ô∏è Ê†áÁ≠æËß¶ÂèëËØÑÂÆ°ÂºÄÂßã"
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --remove-label "state:ready-for-review" \
            --repo ${{ github.repository }}

          echo "üöÄ Running review flow..."
          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post

          echo "üìù Ê†áËÆ∞ÈúÄË¶ÅÊÄªÁªì..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}

          echo "‚úÖ ËØÑÂÆ°ÂÆåÊàê"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false
          # SDK ‰ºòÂåñÔºöË∑≥ËøáÁâàÊú¨Ê£ÄÊü•ÔºåËäÇÁúÅ 2 Áßí
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          # SDK ‰ºòÂåñÔºöÂáèÂ∞ëÁ≠âÂæÖÊó∂Èó¥
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"

  # ========== @mention Ëß¶ÂèëÔºàÂπ∂Ë°åÊâßË°åÔºâ ==========
  process-mention:
    if: github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Skip - @mentions handled by dispatch_agents.yml
        run: |
          echo "‚ÑπÔ∏è @mention Ëß¶ÂèëÁî± dispatch_agents.yml Â§ÑÁêÜ"
          echo "   Êú¨ workflow ‰ªÖÂ§ÑÁêÜÁ≥ªÁªüÂëΩ‰ª§Ôºö/review, /summarize, /triage Á≠â"
          echo "   @mentions ‰ºöËá™Âä® dispatch Âà∞ÂØπÂ∫îÁî®Êà∑ÁöÑ‰ªìÂ∫ìÊâßË°å"

  # ========== /command Ëß¶ÂèëÔºàÈ°∫Â∫èÊâßË°åÔºâ ==========
  process-command:
    if: github.event_name == 'issue_comment' &&
        (contains(github.event.comment.body, '/review') ||
         contains(github.event.comment.body, '/summarize') ||
         contains(github.event.comment.body, '/quiet') ||
         contains(github.event.comment.body, '/triage')) &&
        !contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Cache arxiv-mcp-server
        uses: actions/cache@v4
        with:
          path: ~/.local/share/uv/tools/arxiv-mcp-server
          key: arxiv-mcp-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            arxiv-mcp-${{ runner.os }}-

      - name: Extract command
        id: extract
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if echo "$COMMENT" | grep -q '/review'; then
            echo "command=/review" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/summarize'; then
            echo "command=/summarize" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/quiet'; then
            echo "command=/quiet" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/triage'; then
            echo "command=/triage" >> $GITHUB_OUTPUT
          fi

      # Â§ÑÁêÜ /quiet ÂëΩ‰ª§
      - name: Handle quiet command
        if: steps.extract.outputs.command == '/quiet'
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:quiet" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Â§ÑÁêÜ /triage ÂëΩ‰ª§Ôºö‰ªÖËøêË°å Moderator ÂàÜËØä
      - name: Handle triage command
        if: steps.extract.outputs.command == '/triage'
        run: |
          uv run python -m issuelab execute \
            --issue ${{ github.event.issue.number }} \
            --agents "moderator" \
            --post
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"

      # Â§ÑÁêÜ /review ÂëΩ‰ª§ÔºöËøêË°åÂÆåÊï¥ËØÑÂÆ°ÊµÅÁ®ã
      - name: Run review process
        if: steps.extract.outputs.command == '/review'
        run: |
          echo "üè∑Ô∏è /review ÂëΩ‰ª§Ëß¶ÂèëËØÑÂÆ°"
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --repo ${{ github.repository }}

          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post

          echo "üìù Ê†áËÆ∞ÈúÄË¶ÅÊÄªÁªì..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}

          echo "‚úÖ ËØÑÂÆ°ÂÆåÊàê"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"

      # Â§ÑÁêÜ /summarize ÂëΩ‰ª§
      - name: Run summarizer
        if: steps.extract.outputs.command == '/summarize'
        run: |
          uv run python -m issuelab execute \
            --issue ${{ github.event.issue.number }} \
            --agents "summarizer" \
            --post
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
