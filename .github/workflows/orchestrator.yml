name: Issue Orchestrator

# æ”¯æŒä¸‰ç§è§¦å‘æ–¹å¼ï¼š@mentionã€/commandã€æ ‡ç­¾å˜æ›´
on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [labeled]

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€ Issue ä¸ä¼šå¹¶å‘è¿è¡Œ
concurrency:
  group: ${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  issues: write
  contents: read

jobs:
  # ========== æ ‡ç­¾è§¦å‘ï¼šstate:ready-for-review ==========
  auto-trigger-review:
    if: github.event_name == 'issues' &&
        github.event.action == 'labeled' &&
        github.event.label.name == 'state:ready-for-review'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Install arxiv-mcp-server
        run: uv tool install arxiv-mcp-server

      - name: Run full review process
        run: |
          echo "ğŸ·ï¸ æ ‡ç­¾è§¦å‘è¯„å®¡å¼€å§‹"
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --remove-label "state:ready-for-review" \
            --repo ${{ github.repository }}

          echo "ğŸš€ Running review flow..."
          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post

          echo "ğŸ“ æ ‡è®°éœ€è¦æ€»ç»“..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}

          echo "âœ… è¯„å®¡å®Œæˆ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false

  # ========== @mention è§¦å‘ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰ ==========
  process-mention:
    if: github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Install arxiv-mcp-server
        run: uv tool install arxiv-mcp-server

      - name: Parse @mentions
        id: parse
        run: |
          # ä½¿ç”¨å·²å®‰è£…çš„ issuelab åŒ…ï¼Œé¿å…åŒå±‚åŒ…è£…
          mentions=$(uv run python -m issuelab.cli.mentions \
            --comment-body "${{ github.event.comment.body }}" \
            --output csv)
          echo "mentions=$mentions" >> $GITHUB_OUTPUT
          echo "ğŸ“ Parsed mentions: $mentions"

      - name: Run agents
        if: steps.parse.outputs.mentions != ''
        run: |
          echo "ğŸš€ æ‰§è¡Œ agents: ${{ steps.parse.outputs.mentions }}"
          mkdir -p ${{ github.workspace }}/logs
          uv run python -m issuelab execute \
            --issue ${{ github.event.issue.number }} \
            --agents "${{ steps.parse.outputs.mentions }}" \
            --post
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          LOG_FILE: ${{ github.workspace }}/logs/execute_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.event.issue.number }}-${{ github.run_number }}
          path: ${{ github.workspace }}/logs/
          retention-days: 7

  # ========== /command è§¦å‘ï¼ˆé¡ºåºæ‰§è¡Œï¼‰ ==========
  process-command:
    if: github.event_name == 'issue_comment' &&
        (contains(github.event.comment.body, '/review') ||
         contains(github.event.comment.body, '/summarize') ||
         contains(github.event.comment.body, '/quiet') ||
         contains(github.event.comment.body, '/triage')) &&
        !contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Install arxiv-mcp-server
        run: uv tool install arxiv-mcp-server

      - name: Extract command
        id: extract
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if echo "$COMMENT" | grep -q '/review'; then
            echo "command=/review" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/summarize'; then
            echo "command=/summarize" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/quiet'; then
            echo "command=/quiet" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/triage'; then
            echo "command=/triage" >> $GITHUB_OUTPUT
          fi

      # å¤„ç† /quiet å‘½ä»¤
      - name: Handle quiet command
        if: steps.extract.outputs.command == '/quiet'
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:quiet" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å¤„ç† /triage å‘½ä»¤ï¼šä»…è¿è¡Œ Moderator åˆ†è¯Š
      - name: Handle triage command
        if: steps.extract.outputs.command == '/triage'
        run: |
          uv run python -m issuelab execute \
            --issue ${{ github.event.issue.number }} \
            --agents "moderator" \
            --post
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false

      # å¤„ç† /review å‘½ä»¤ï¼šè¿è¡Œå®Œæ•´è¯„å®¡æµç¨‹
      - name: Run review process
        if: steps.extract.outputs.command == '/review'
        run: |
          echo "ğŸ·ï¸ /review å‘½ä»¤è§¦å‘è¯„å®¡"
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --repo ${{ github.repository }}

          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post

          echo "ğŸ“ æ ‡è®°éœ€è¦æ€»ç»“..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}

          echo "âœ… è¯„å®¡å®Œæˆ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false

      # å¤„ç† /summarize å‘½ä»¤
      - name: Run summarizer
        if: steps.extract.outputs.command == '/summarize'
        run: |
          uv run python -m issuelab execute \
            --issue ${{ github.event.issue.number }} \
            --agents "summarizer" \
            --post
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          ENABLE_GITHUB_MCP: false
