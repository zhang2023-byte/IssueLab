name: Observer Auto-Trigger

# Observer å®šæœŸæ‰«æ Issues å¹¶è‡ªä¸»å†³å®šæ˜¯å¦è§¦å‘è¯„å®¡
on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# å¹¶å‘æ§åˆ¶ï¼šé¿å…å¤šæ¬¡æ‰«æå †ç§¯
concurrency:
  group: observer-scan
  cancel-in-progress: true

permissions:
  issues: write
  contents: read

jobs:
  observer-scan:
    # ğŸ”’ ä»…åœ¨ä¸»ä»“åº“è¿è¡Œï¼Œé¿å…åœ¨forkä»“åº“ä¸­ä¸å¿…è¦çš„å®šæ—¶æ‰§è¡Œ
    if: github.repository == 'gqy20/IssueLab'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      # æš‚æ—¶ç¦ç”¨ MCP å®‰è£…ä»¥æµ‹è¯•æ€§èƒ½
      - name: Install arxiv-mcp-server
        run: uv tool install arxiv-mcp-server

      - name: Get open issues
        id: get_issues
        run: |
          # è·å–æ‰€æœ‰å¼€æ”¾çš„ issuesï¼ˆæ’é™¤å·²æ ‡è®°ä¸º processing æˆ– quiet çš„ï¼‰
          gh issue list \
            --json number,labels \
            --jq '.[] | select(
              (.labels | map(.name) | contains(["bot:processing", "bot:quiet"]) | not)
            ) | .number' \
            > /tmp/issue_numbers.txt

          # è¯»å– issue ç¼–å·å¹¶è½¬ä¸ºé€—å·åˆ†éš”
          ISSUE_NUMBERS=$(cat /tmp/issue_numbers.txt | tr '\n' ',' | sed 's/,$//')
          ISSUE_COUNT=$(wc -l < /tmp/issue_numbers.txt)

          echo "æ‰¾åˆ° $ISSUE_COUNT ä¸ªå¾…è§‚å¯Ÿçš„ issues: $ISSUE_NUMBERS"
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          echo "issue_numbers=$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Observer for all issues (parallel)
        if: steps.get_issues.outputs.issue_count > 0
        run: |
          echo "=== å¹¶è¡Œåˆ†æ ${{ steps.get_issues.outputs.issue_count }} ä¸ª Issues ==="

          # ğŸ”¥ ä½¿ç”¨æ–°çš„ auto-trigger å‚æ•°æ›¿ä»£ --postï¼ˆé¿å…botè¯„è®ºè§¦å‘é—®é¢˜ï¼‰
          uv run python -m issuelab observe-batch \
            --issues "${{ steps.get_issues.outputs.issue_numbers }}" \
            --auto-trigger

          echo "=== åˆ†æå®Œæˆ ==="
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_KEY: ${{ secrets.ANTHROPIC_AUTH_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          LOG_FILE: ${{ github.workspace }}/logs/observer_${{ github.run_id }}.log
          LOG_LEVEL: DEBUG
          ENABLE_ARXIV_MCP: false
          ENABLE_GITHUB_MCP: false

      # ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: observer-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore
