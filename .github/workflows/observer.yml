name: Observer Auto-Trigger

# Observer 定期扫描 Issues 并自主决定是否触发评审
on:
  schedule:
    # 每小时运行一次
    - cron: '0 * * * *'
  workflow_dispatch:  # 允许手动触发

permissions:
  issues: write
  contents: read

jobs:
  observer-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Install arxiv-mcp-server
        run: uv tool install arxiv-mcp-server

      - name: Get open issues
        id: get_issues
        run: |
          # 获取所有开放的 issues（排除已标记为 processing 或 quiet 的）
          gh issue list \
            --json number,labels \
            --jq '.[] | select(
              (.labels | map(.name) | contains(["bot:processing", "bot:quiet"]) | not)
            ) | .number' \
            > /tmp/issue_numbers.txt
          
          # 读取 issue 编号
          ISSUE_COUNT=$(wc -l < /tmp/issue_numbers.txt)
          echo "找到 $ISSUE_COUNT 个待观察的 issues"
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Observer for each issue
        if: steps.get_issues.outputs.issue_count > 0
        run: |
          while read -r issue_number; do
            if [ -z "$issue_number" ]; then
              continue
            fi
            
            echo "=== 分析 Issue #$issue_number ==="
            
            # 获取 Issue 详情
            ISSUE_TITLE=$(gh issue view "$issue_number" --json title -q '.title')
            ISSUE_BODY=$(gh issue view "$issue_number" --json body -q '.body')
            
            # 获取评论
            gh issue view "$issue_number" \
              --json comments \
              --jq '.comments[] | "- **[\(.author.login)]** (\(.createdAt | strptime("%Y-%m-%dT%H:%M:%SZ") | strftime("%Y-%m-%d %H:%M")):\n\(.body))"' \
              > /tmp/comments_${issue_number}.txt
            
            COMMENT_COUNT=$(gh issue view "$issue_number" --json comments --jq '.comments | length')
            COMMENTS=$(cat /tmp/comments_${issue_number}.txt)
            
            # 运行 Observer Agent
            uv run python -m issuelab observe \
              --issue "$issue_number" \
              --title "$ISSUE_TITLE" \
              --context "$ISSUE_BODY" \
              --comments "$COMMENTS" \
              --comment-count "$COMMENT_COUNT" \
              --post
            
            echo ""
          done < /tmp/issue_numbers.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          ARXIV_STORAGE_PATH: ${{ github.workspace }}/.arxiv-papers
          ENABLE_ARXIV_MCP: true
          LOG_LEVEL: INFO
