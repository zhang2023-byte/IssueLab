name: Auto-Close Stale Issues

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      max_comments:
        description: 'Max comments threshold (default: 200)'
        required: false
        default: '200'
        type: string
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: 'false'
        type: boolean

env:
  GH_TOKEN: ${{ secrets.PAT_TOKEN }}

permissions:
  issues: write

jobs:
  close-stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Close issues with >N comments
        run: |
          # é…ç½®
          MAX_COMMENTS=${{ github.event.inputs.max_comments || '200' }}
          DRY_RUN=${{ github.event.inputs.dry_run || 'true' }}
          REPO="${{ github.repository }}"

          echo "ğŸ” æ£€æŸ¥è¶…è¿‡ $MAX_COMMENTS å›å¤çš„ issue..."
          echo "ğŸ“Š ä»“åº“: $REPO"
          echo "ğŸ”¬ æ¨¡å¼: $([ "$DRY_RUN" = "true" ] && echo "å¹²è¿è¡Œ" || echo "å®é™…æ‰§è¡Œ")"
          echo ""

          # è·å–è¶…è¿‡ N å›å¤çš„ open issue
          ISSUES=$(gh issue list \
            --repo "$REPO" \
            --state open \
            --limit 300 \
            --json number,title,comments \
            --jq ".[] | select(.comments > $MAX_COMMENTS) | .number")

          if [ -z "$ISSUES" ]; then
            echo "âœ… æ²¡æœ‰éœ€è¦å…³é—­çš„ issue"
            exit 0
          fi

          COUNT=$(echo "$ISSUES" | wc -l)
          echo "âš ï¸  å‘ç° $COUNT ä¸ªéœ€è¦å…³é—­çš„ issue:"
          echo ""

          for issue_num in $ISSUES; do
            TITLE=$(gh issue view $issue_num --repo "$REPO" --json title --jq '.title')
            COMMENTS=$(gh issue view $issue_num --repo "$REPO" --json comments --jq '.comments | length')

            echo "  #$issue_num: $TITLE"
            echo "     å›å¤æ•°: $COMMENTS"

            if [ "$DRY_RUN" = "false" ]; then
              gh issue close $issue_num \
                --repo "$REPO" \
                --comment "ğŸ¤– æ­¤ issue å·²è¶…è¿‡ $MAX_COMMENTS å›å¤ï¼Œè‡ªåŠ¨å…³é—­ã€‚å¦‚éœ€ç»§ç»­è®¨è®ºï¼Œè¯·å¼€å¯æ–° issueã€‚"
              echo "     â†’ å·²å…³é—­"
            else
              echo "     â†’ [å¹²è¿è¡Œ] å°†è¢«å…³é—­"
            fi
            echo ""
          done

          if [ "$DRY_RUN" = "false" ]; then
            echo "âœ… å®Œæˆï¼šå…³é—­äº† $COUNT ä¸ª issue"
          else
            echo "â„¹ï¸  å¹²è¿è¡Œå®Œæˆï¼š$COUNT ä¸ª issue å°†è¢«å…³é—­"
          fi
