name: Run Agent on Dispatch

on:
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent name to run'
        required: true
        type: string
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: string
  repository_dispatch:
    types: [agent_trigger]

permissions:
  contents: read
  issues: write

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Get agent name
        id: agent
        run: |
          # workflow_dispatch: ‰ΩøÁî®ËæìÂÖ•ÁöÑagentÂêçÁß∞
          # repository_dispatch: ‰ªé‰ªìÂ∫ìÂêçÊèêÂèñÔºàÂ¶Ç gqy22/IssueLab -> gqy22Ôºâ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            agent="${{ inputs.agent }}"
          else
            agent="${GITHUB_REPOSITORY%/*}"
          fi
          echo "name=$agent" >> $GITHUB_OUTPUT
          echo "ü§ñ Agent: $agent"

      - name: Run agent
        run: |
          # Ëé∑ÂèñÂèÇÊï∞Ôºöworkflow_dispatch Êàñ repository_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
            SOURCE_REPO="${{ github.repository }}"
          else
            ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
            SOURCE_REPO="${{ github.event.client_payload.source_repo }}"
          fi

          echo "üöÄ ÊâßË°å agent: ${{ steps.agent.outputs.name }}"
          echo "üìù Source repo: $SOURCE_REPO"
          echo "üìù Issue: $ISSUE_NUMBER"

          mkdir -p ${{ github.workspace }}/logs

          # ÊâßË°å agent
          GH_REPO="$SOURCE_REPO" uv run python -m issuelab execute \
            --issue "$ISSUE_NUMBER" \
            --agents "${{ steps.agent.outputs.name }}" \
            --post
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/agent_${{ github.event.client_payload.issue_number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
          ACTIONS_STEP_DEBUG: "true"
          ACTIONS_RUNNER_DEBUG: "true"

      - uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.event.client_payload.issue_number }}
          path: logs/
          retention-days: 7

      - name: Comment on failure
        if: failure()
        run: |
          # Ëé∑ÂèñÂèÇÊï∞
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
            SOURCE_REPO="${{ github.repository }}"
          else
            ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
            SOURCE_REPO="${{ github.event.client_payload.source_repo }}"
          fi

          GH_REPO="$SOURCE_REPO" gh issue comment "$ISSUE_NUMBER" \
            --body "‚ùå Agent ${{ steps.agent.outputs.name }} execution failed. Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
