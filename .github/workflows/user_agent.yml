name: Run Agent on Workflow Dispatch

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        type: string
      issue_number:
        description: 'Issue number'
        required: true
        type: string
      issue_title:
        description: 'Issue title'
        required: false
        type: string
      issue_body:
        description: 'Issue body'
        required: false
        type: string
      comment_id:
        description: 'Comment ID'
        required: false
        type: string
      comment_body:
        description: 'Comment body'
        required: false
        type: string
      labels:
        description: 'Issue labels (JSON array)'
        required: false
        type: string
      target_username:
        description: 'Target agent username'
        required: false
        type: string
      available_agents:
        description: 'Available agents in the system (JSON array)'
        required: false
        type: string

permissions:
  contents: read
  issues: write

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv pip install --system \
            anthropic \
            PyYAML \
            PyGithub

      - name: Extract agent username
        id: agent
        run: |
          # ä»ä»“åº“åæå–ç”¨æˆ·åï¼ˆå‡è®¾ä»“åº“åæ˜¯ username/IssueLabï¼‰
          username="${{ github.repository_owner }}"
          echo "username=$username" >> $GITHUB_OUTPUT
          echo "Agent username: $username"

      - name: Check agent config exists
        id: check
        run: |
          config_file="agents/${{ steps.agent.outputs.username }}/agent.yml"
          prompt_file="agents/${{ steps.agent.outputs.username }}/prompt.md"

          if [ ! -f "$config_file" ]; then
            echo "Error: Agent config not found: $config_file"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ ! -f "$prompt_file" ]; then
            echo "Error: Agent prompt not found: $prompt_file"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "exists=true" >> $GITHUB_OUTPUT
          echo "config_file=$config_file" >> $GITHUB_OUTPUT
          echo "prompt_file=$prompt_file" >> $GITHUB_OUTPUT

      - name: Run agent
        if: steps.check.outputs.exists == 'true'
        id: run_agent
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          # ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·PATï¼Œfallbackåˆ°é»˜è®¤token
          # é…ç½®PATåï¼Œå›å¤ä¼šæ˜¾ç¤ºç”¨æˆ·æœ¬äººè€Œébot
          # gh CLI ä¼šä¼˜å…ˆä½¿ç”¨ GH_TOKENï¼Œç„¶åæ˜¯ GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          LOG_FILE: ${{ github.workspace }}/logs/user_agent_${{ inputs.issue_number }}.log
          LOG_LEVEL: DEBUG
          ENABLE_ARXIV_MCP: "false"
          ENABLE_GITHUB_MCP: "false"
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
        run: |
          echo "Running agent for: ${{ steps.agent.outputs.username }}"
          echo "Source Issue: ${{ inputs.source_repo }}#${{ inputs.issue_number }}"

          uv run python -m issuelab personal-reply \
            --agent "${{ steps.agent.outputs.username }}" \
            --issue ${{ inputs.issue_number }} \
            --repo "${{ inputs.source_repo }}" \
            --issue-title "${{ inputs.issue_title }}" \
            --issue-body "${{ inputs.issue_body }}" \
            ${{ inputs.available_agents && format('--available-agents ''{0}''', inputs.available_agents) || '' }} \
            --post

          echo "Agent execution completed"

      # Fallback: å¦‚æœç”¨æˆ·æ²¡æœ‰é…ç½®PATæ— æ³•ç›´æ¥è¯„è®ºï¼Œå°†ç»“æœä¿å­˜å¹¶æç¤º
      - name: Save response for manual posting
        if: always() && steps.run_agent.outputs.comment_failed == 'true'
        run: |
          echo "âš ï¸ Agent executed successfully but couldn't post comment to main repo"
          echo "ğŸ“ Response saved in logs/user_agent_${{ inputs.issue_number }}.log"
          echo ""
          echo "ğŸ’¡ To enable auto-posting with your identity:"
          echo "1. Create a Personal Access Token (PAT) at https://github.com/settings/tokens"
          echo "2. Grant 'repo' and 'workflow' permissions"
          echo "3. Add as PERSONAL_GITHUB_TOKEN secret in your repository settings"
          echo ""
          echo "Benefits:"
          echo "- Comments show as YOU (not github-actions bot)"
          echo "- Can trigger other workflows with @mentions"
          echo "- Full cross-repo permissions"

      # ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: user-agent-logs-${{ inputs.issue_number }}-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Comment on config error
        if: failure() && steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = '${{ inputs.source_repo }}'.split('/');
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: ${{ inputs.issue_number }},
              body: `âš ï¸ @${{ steps.agent.outputs.username }}'s agent configuration is missing or invalid. Please check your fork.`
            });

      - name: Comment on execution error
        if: failure() && steps.check.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = '${{ inputs.source_repo }}'.split('/');
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: ${{ inputs.issue_number }},
              body: `âŒ @${{ steps.agent.outputs.username }}'s agent encountered an error. Please check the [Actions logs](https://github.com/${{ github.repository }}/actions).`
            });
